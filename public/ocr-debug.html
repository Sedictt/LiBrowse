<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OCR Debug Console - Booqy Developer Tools</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            background: #1a1a1a;
            color: #e0e0e0;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }

        .header h1 {
            color: white;
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .header p {
            color: rgba(255,255,255,0.9);
            font-size: 1.1rem;
        }

        .upload-section {
            background: #2d2d2d;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            border: 2px dashed #555;
        }

        .upload-area {
            border: 2px dashed #666;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #333;
        }

        .upload-area:hover {
            border-color: #667eea;
            background: #3a3a3a;
        }

        .upload-area.drag-over {
            border-color: #667eea;
            background: #3a3a5a;
        }

        .upload-icon {
            font-size: 3rem;
            color: #667eea;
            margin-bottom: 15px;
        }

        .upload-text {
            font-size: 1.2rem;
            margin-bottom: 10px;
        }

        .upload-hint {
            color: #aaa;
            font-size: 0.9rem;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            margin: 10px 5px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn:disabled {
            background: #555;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .debug-panels {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        .debug-panel {
            background: #2d2d2d;
            border-radius: 10px;
            padding: 20px;
            border: 1px solid #444;
        }

        .panel-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #444;
        }

        .panel-icon {
            font-size: 1.5rem;
            margin-right: 10px;
            color: #667eea;
        }

        .panel-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #fff;
        }

        .log-output {
            background: #1a1a1a;
            border: 1px solid #444;
            border-radius: 6px;
            padding: 15px;
            height: 300px;
            overflow-y: auto;
            font-family: 'Consolas', monospace;
            font-size: 0.9rem;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .extracted-text {
            background: #1a1a1a;
            border: 1px solid #444;
            border-radius: 6px;
            padding: 15px;
            height: 200px;
            overflow-y: auto;
            font-family: 'Consolas', monospace;
            font-size: 0.9rem;
            white-space: pre-wrap;
            word-wrap: break-word;
            color: #90EE90;
        }

        .match-results {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
            margin-top: 15px;
        }

        .match-item {
            background: #1a1a1a;
            border-radius: 6px;
            padding: 15px;
            text-align: center;
            border: 2px solid #444;
        }

        .match-item.success {
            border-color: #4CAF50;
            background: rgba(76, 175, 80, 0.1);
        }

        .match-item.failure {
            border-color: #f44336;
            background: rgba(244, 67, 54, 0.1);
        }

        .match-label {
            font-size: 0.9rem;
            color: #aaa;
            margin-bottom: 5px;
        }

        .match-value {
            font-size: 1.1rem;
            font-weight: 600;
            color: #fff;
        }

        .match-status {
            font-size: 0.8rem;
            margin-top: 5px;
            padding: 4px 8px;
            border-radius: 4px;
            display: inline-block;
        }

        .match-status.success {
            background: #4CAF50;
            color: white;
        }

        .match-status.failure {
            background: #f44336;
            color: white;
        }

        .confidence-meter {
            background: #1a1a1a;
            border-radius: 6px;
            padding: 15px;
            margin-top: 15px;
        }

        .confidence-bar {
            width: 100%;
            height: 20px;
            background: #333;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }

        .confidence-fill {
            height: 100%;
            background: linear-gradient(90deg, #f44336 0%, #ff9800 50%, #4CAF50 100%);
            width: 0%;
            transition: width 0.5s ease;
        }

        .confidence-text {
            text-align: center;
            font-weight: 600;
            color: #fff;
        }

        .file-info {
            background: #333;
            border-radius: 6px;
            padding: 15px;
            margin: 15px 0;
            display: none;
        }

        .file-info.show {
            display: block;
        }

        .processing-indicator {
            display: none;
            text-align: center;
            padding: 20px;
            color: #667eea;
        }

        .processing-indicator.show {
            display: block;
        }

        .spinner {
            display: inline-block;
            width: 30px;
            height: 30px;
            border: 3px solid rgba(102, 126, 234, 0.3);
            border-radius: 50%;
            border-top-color: #667eea;
            animation: spin 1s ease-in-out infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .clear-logs {
            background: #f44336;
            margin-left: auto;
        }

        .clear-logs:hover {
            background: #d32f2f;
        }

        @media (max-width: 768px) {
            .debug-panels {
                grid-template-columns: 1fr;
            }
            
            .match-results {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üî¨ OCR Debug Console</h1>
            <p>Real-time OCR processing insights and text extraction analysis</p>
        </div>

        <div class="upload-section">
            <div class="upload-area" id="uploadArea">
                <div class="upload-icon">üìÑ</div>
                <div class="upload-text">Drop your document here or click to browse</div>
                <div class="upload-hint">Supports JPG, PNG, PDF (max 5MB)</div>
            </div>
            <input type="file" id="fileInput" accept=".jpg,.jpeg,.png,.pdf" style="display: none;">
            
            <div class="file-info" id="fileInfo">
                <strong>Selected File:</strong> <span id="fileName"></span><br>
                <strong>Size:</strong> <span id="fileSize"></span><br>
                <strong>Type:</strong> <span id="fileType"></span>
            </div>

            <div class="test-data-section" style="margin-top: 20px; padding: 15px; background: #333; border-radius: 6px;">
                <h4 style="color: #667eea; margin-bottom: 15px;">üß™ Test Data (Optional)</h4>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                    <div>
                        <label style="display: block; margin-bottom: 5px; color: #aaa;">Your Student ID:</label>
                        <input type="text" id="testStudentId" placeholder="e.g., 21-1234" style="width: 100%; padding: 8px; background: #1a1a1a; border: 1px solid #555; border-radius: 4px; color: #fff;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 5px; color: #aaa;">Your Full Name:</label>
                        <input type="text" id="testFullName" placeholder="e.g., Juan Dela Cruz" style="width: 100%; padding: 8px; background: #1a1a1a; border: 1px solid #555; border-radius: 4px; color: #fff;">
                    </div>
                </div>
                <small style="color: #888;">üí° Enter your actual student ID and name to test real matching. Leave blank to use default test data.</small>
            </div>

            <div style="text-align: center; margin-top: 20px;">
                <button class="btn" id="processBtn" disabled>üöÄ Process with OCR</button>
                <button class="btn clear-logs" id="clearBtn">üóëÔ∏è Clear Logs</button>
            </div>

            <div class="processing-indicator" id="processingIndicator">
                <div class="spinner"></div>
                Processing document with OCR...
            </div>
        </div>

        <div class="debug-panels">
            <div class="debug-panel">
                <div class="panel-header">
                    <div class="panel-icon">üìù</div>
                    <div class="panel-title">Extracted Text</div>
                </div>
                <div class="extracted-text" id="extractedText">
                    No text extracted yet. Upload and process a document to see OCR results.
                </div>
            </div>

            <div class="debug-panel">
                <div class="panel-header">
                    <div class="panel-icon">üîç</div>
                    <div class="panel-title">Processing Logs</div>
                </div>
                <div class="log-output" id="logOutput">
                    Waiting for OCR processing...
                </div>
            </div>
        </div>

        <div class="debug-panel">
            <div class="panel-header">
                <div class="panel-icon">‚úÖ</div>
                <div class="panel-title">Matching Results</div>
            </div>
            
            <div class="match-results" id="matchResults">
                <div class="match-item">
                    <div class="match-label">Student ID</div>
                    <div class="match-value" id="studentIdValue">-</div>
                    <div class="match-status" id="studentIdStatus">Pending</div>
                </div>
                <div class="match-item">
                    <div class="match-label">Name</div>
                    <div class="match-value" id="nameValue">-</div>
                    <div class="match-status" id="nameStatus">Pending</div>
                </div>
                <div class="match-item">
                    <div class="match-label">University</div>
                    <div class="match-value" id="universityValue">-</div>
                    <div class="match-status" id="universityStatus">Pending</div>
                </div>
            </div>

            <div class="confidence-meter">
                <div class="confidence-text">Overall Confidence: <span id="confidenceText">0%</span></div>
                <div class="confidence-bar">
                    <div class="confidence-fill" id="confidenceFill"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        class OCRDebugConsole {
            constructor() {
                this.selectedFile = null;
                this.init();
            }

            init() {
                this.setupEventListeners();
                this.log('OCR Debug Console initialized');
            }

            setupEventListeners() {
                const uploadArea = document.getElementById('uploadArea');
                const fileInput = document.getElementById('fileInput');
                const processBtn = document.getElementById('processBtn');
                const clearBtn = document.getElementById('clearBtn');

                // Click to browse
                uploadArea.addEventListener('click', () => fileInput.click());

                // Drag and drop
                uploadArea.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    uploadArea.classList.add('drag-over');
                });

                uploadArea.addEventListener('dragleave', () => {
                    uploadArea.classList.remove('drag-over');
                });

                uploadArea.addEventListener('drop', (e) => {
                    e.preventDefault();
                    uploadArea.classList.remove('drag-over');
                    const files = e.dataTransfer.files;
                    if (files.length > 0) {
                        this.handleFile(files[0]);
                    }
                });

                // File input change
                fileInput.addEventListener('change', (e) => {
                    if (e.target.files.length > 0) {
                        this.handleFile(e.target.files[0]);
                    }
                });

                // Process button
                processBtn.addEventListener('click', () => {
                    this.processDocument();
                });

                // Clear button
                clearBtn.addEventListener('click', () => {
                    this.clearLogs();
                });
            }

            handleFile(file) {
                // Validate file
                const maxSize = 5 * 1024 * 1024; // 5MB
                const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'application/pdf'];

                if (file.size > maxSize) {
                    this.log('‚ùå File size too large (max 5MB)', 'error');
                    return;
                }

                if (!allowedTypes.includes(file.type)) {
                    this.log('‚ùå Invalid file type. Only JPG, PNG, PDF allowed', 'error');
                    return;
                }

                this.selectedFile = file;
                this.showFileInfo(file);
                document.getElementById('processBtn').disabled = false;
                this.log(`üìÅ File selected: ${file.name} (${this.formatFileSize(file.size)})`);
            }

            showFileInfo(file) {
                const fileInfo = document.getElementById('fileInfo');
                document.getElementById('fileName').textContent = file.name;
                document.getElementById('fileSize').textContent = this.formatFileSize(file.size);
                document.getElementById('fileType').textContent = file.type;
                fileInfo.classList.add('show');
            }

            async processDocument() {
                if (!this.selectedFile) {
                    this.log('‚ùå No file selected', 'error');
                    return;
                }

                this.showProcessing(true);
                this.log('üöÄ Starting OCR processing...');
                
                try {
                    const formData = new FormData();
                    formData.append('frontId', this.selectedFile);

                    // Add test data if provided
                    const testStudentId = document.getElementById('testStudentId').value.trim();
                    const testFullName = document.getElementById('testFullName').value.trim();
                    
                    if (testStudentId) {
                        formData.append('test_student_id', testStudentId);
                        this.log(`üß™ Using test student ID: ${testStudentId}`);
                    }
                    if (testFullName) {
                        formData.append('test_full_name', testFullName);
                        this.log(`üß™ Using test full name: ${testFullName}`);
                    }

                    this.log('üì§ Uploading document to server...');

                    const response = await fetch('/api/verification/upload-documents-test', {
                        method: 'POST',
                        body: formData
                    });

                    this.log(`üì• Server response: ${response.status} ${response.statusText}`);

                    const result = await response.json();

                    if (result.success) {
                        this.log('‚úÖ OCR processing completed successfully!');
                        this.displayResults(result);
                    } else {
                        this.log(`‚ùå OCR processing failed: ${result.message}`, 'error');
                    }

                } catch (error) {
                    this.log(`üí• Processing error: ${error.message}`, 'error');
                } finally {
                    this.showProcessing(false);
                }
            }

            displayResults(result) {
                // Display preprocessing results if available
                if (result.preprocessingResults) {
                    this.log('üé® Image Preprocessing Results:');
                    result.preprocessingResults.forEach(prep => {
                        this.log(`  ${prep.method}: ${prep.confidence}% confidence, ${prep.textLength} chars`);
                    });
                    this.log(`üèÜ Best method: ${result.method} (${result.description})`);
                }

                // Display extracted text
                const extractedText = result.extractedText || 'No text extracted';
                document.getElementById('extractedText').textContent = extractedText;
                this.log(`üìù Extracted text (${extractedText.length} characters):`);
                this.log(extractedText.substring(0, 200) + (extractedText.length > 200 ? '...' : ''));

                // Display extracted info
                const info = result.results?.front?.extractedInfo || result.extractedInfo || {};
                this.log('üîç Extracted Information:');
                this.log(`  Student ID: ${info.studentId || 'Not found'}`);
                this.log(`  Name: ${info.name || 'Not found'}`);
                this.log(`  University: ${info.university || 'Not found'}`);

                // Display matching results
                const matches = info.matches || {};
                this.log('‚úÖ Matching Results:');
                this.log(`  Student ID Match: ${matches.studentId ? '‚úÖ YES' : '‚ùå NO'}`);
                this.log(`  Name Match: ${matches.name ? '‚úÖ YES' : '‚ùå NO'}`);
                this.log(`  University Match: ${matches.university ? '‚úÖ YES' : '‚ùå NO'}`);

                // Update UI
                this.updateMatchDisplay('studentId', info.studentId, matches.studentId);
                this.updateMatchDisplay('name', info.name, matches.name);
                this.updateMatchDisplay('university', info.university, matches.university);

                // Display confidence
                const confidence = result.combinedConfidence || result.results?.front?.confidence || result.confidence || 0;
                this.updateConfidence(confidence);
                this.log(`üìä Overall Confidence: ${confidence}%`);
                
                // Display OCR-specific metrics
                if (result.ocrConfidence) {
                    this.log(`üîç Raw OCR Confidence: ${result.ocrConfidence}%`);
                }
                if (result.wordCount) {
                    this.log(`üìä Words Detected: ${result.wordCount}`);
                }
                if (result.processingTime) {
                    this.log(`‚è±Ô∏è Total Processing Time: ${result.processingTime}ms`);
                }

                // Display verification decision
                const autoApproved = result.autoApproved;
                this.log(`üéØ Verification Decision: ${autoApproved ? '‚úÖ AUTO-APPROVED' : '‚è≥ REQUIRES REVIEW'}`);
                
                if (autoApproved) {
                    this.log('üéâ User would be automatically verified!');
                } else {
                    this.log('üëÄ Document requires manual admin review');
                }
            }

            updateMatchDisplay(type, value, isMatch) {
                const valueEl = document.getElementById(`${type}Value`);
                const statusEl = document.getElementById(`${type}Status`);
                const itemEl = valueEl.closest('.match-item');

                valueEl.textContent = value || 'Not found';
                statusEl.textContent = isMatch ? 'MATCH' : 'NO MATCH';
                statusEl.className = `match-status ${isMatch ? 'success' : 'failure'}`;
                itemEl.className = `match-item ${isMatch ? 'success' : 'failure'}`;
            }

            updateConfidence(confidence) {
                const confidenceText = document.getElementById('confidenceText');
                const confidenceFill = document.getElementById('confidenceFill');

                confidenceText.textContent = `${confidence}%`;
                confidenceFill.style.width = `${confidence}%`;
            }

            showProcessing(show) {
                const indicator = document.getElementById('processingIndicator');
                indicator.classList.toggle('show', show);
                document.getElementById('processBtn').disabled = show;
            }

            log(message, type = 'info') {
                const logOutput = document.getElementById('logOutput');
                const timestamp = new Date().toLocaleTimeString();
                const emoji = type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : '‚ÑπÔ∏è';
                
                const logEntry = `[${timestamp}] ${emoji} ${message}\n`;
                logOutput.textContent += logEntry;
                logOutput.scrollTop = logOutput.scrollHeight;
            }

            clearLogs() {
                document.getElementById('logOutput').textContent = '';
                document.getElementById('extractedText').textContent = 'No text extracted yet. Upload and process a document to see OCR results.';
                
                // Reset match displays
                ['studentId', 'name', 'university'].forEach(type => {
                    this.updateMatchDisplay(type, '-', false);
                    document.getElementById(`${type}Status`).textContent = 'Pending';
                    document.getElementById(`${type}Status`).className = 'match-status';
                    document.getElementById(`${type}Value`).closest('.match-item').className = 'match-item';
                });

                // Reset confidence
                this.updateConfidence(0);
                
                this.log('üßπ Logs cleared');
            }

            formatFileSize(bytes) {
                if (bytes === 0) return '0 Bytes';
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', () => {
            new OCRDebugConsole();
        });
    </script>
</body>
</html>
